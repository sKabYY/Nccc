using Microsoft.VisualStudio.TestTools.UnitTesting;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace Nccc.Tests
{
    [TestClass]
    public class CfpInterpreterTests
    {
        public const string cfp = @"
CAFPS FLIGHTPLAN FMT01 FOR HEBEI AIRLINES
PLAN 2716398 NS3276 ZSNT TO ZBSJ EMB190 290/0.76/F IFR 2018-7-8
NONSTOP COMPUTED 0152Z FOR ETD 1345Z HLAFS 2018070808012  3140 KGS
---------------------------------------------------------------------
                    CLM          CRZ        DES         ALTN   
FLIGHT PROFILE  250/270/0.73 290/0.76   0.76/290/250 290/0.76  

---------------------------------------------------------------------

BLOCK IN . . . .      OFF . . .        LDG . . .   T/O FUEL . . .

BLOCK OUT  . . .      ON  . . .        T/O . . .   LDG FUEL . . .

TOTAL    . . . .   TOTAL  . . .      TOTAL . . .  FUEL USED . . .

REASON FOR DELAY  . . . . . . . . . . . . . . . . . . . . . . . . 

---------------------------------------------------------------------

ALLOCATED FL:

           FUEL  TIME  DIST ARRIVE   TOW    LDW     PLD     DOW     ZFW
DEST ZBSJ 003507 01/36 0591  1521Z  039645 036138  004244  028825 033069
RESV      001620 00/45
ALTN ZSJN 001449 00/41 0223  1602Z FLAPS...... V1......   BFL.......
HOLD      000000 00/00
REQD      006576 03/02             TEMP....... VR......   N1........
XTRA      000000 00/00
TKOF      006576 03/02 TRK ZSNTZBSJ1           V2......   T/OFF.....
TAXI      000200 00/00
TOTL      006776 

                                               VSE.....   T/ON......

TAKEOFF FUEL: 1.5Min   142KG
APPROCH FUEL: 3.0Min   79KG

REASON FOR EXTRA FUEL: 

FUEL BURN ADJUSTMENT FOR 1000KGS INCR/DECR IN TOW: 0008KGS/0007KGS

PLAN ROUTE:
ZSNT..NTG..W109..PIKAS..G330..PIMOL..A593..DALIM..W157..P148..H8..HG..
J42..SJW..ZBSJ

WIND M007   MXSH 4/FL
TAS 343   98/PIKAS 197/PIMOL 256/TUMLO 157/HG 118
------------------------------------------------------------------------

ALT.LEVEL                                          ETE    WIND    FUEL
118/PIKAS 217/PIMOL 276/TUMLO 177/HG 138          01/34   M009   003427
79/PIKAS 177/PIMOL 236/TUMLO 138/HG 98          01/38   M005   003580
59/PIKAS 157/PIMOL 217/TUMLO 118/HG 79          01/40   M003   003674
------------------------------------------------------------------------

DEPARTURE ATIS:

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

ATC CLEARANCE:

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

------------------------------------------------------------------------
                                  RVSM
RAMP COORD-....................... COAST OUT COORD-.....................
ALTIMETER NO.1-................... ALTIMETER NO.1-......................
          NO.2-...................           NO.2-......................
          STBY-...................           STBY-......................
------------------------------------------------------------------------

ZSNT ELEV 00016FT

CPT     FLT T   WIND  S  TAS MCS   AWY DST DSTR ETE  ETR  FU   FR    FF/E
FREQ    TRO TDV COMP     GRS TCS   MSA          ETA  ATR  AFU  AFR
-------------------------------------------------------------------------
 TOC     98  ..  .... .. ... ...    .. 011 0580 0004 0092 0328 06248 ....
        ... ...  ....    ... ...   ... ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 NTG     98 P13 19013 1  343 ...    .. 010 0570 0002 0091 0061 06187 1140
 115.6  ... P17  P013    356 359   ... ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 PIKAS   98 P13 19013 1  343 294  W109 013 0557 0002 0088 0086 06101 1140
        ... P17  P001    344 287  2320 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 UNTAN  197 M05 23007 1  400 281  G330 023 0534 0004 0084 0260 05841 1941
        ... P19  M005    395 276  2815 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 PIMOL  197 M05 24008 1  400 281  G330 027 0507 0004 0080 0148 05693 1080
        ... P19  M007    393 276  2815 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 XUTGU  ... M17 26012 2  ... 330  A593 016 0491 .... .... .... ..... ....
        ... P19  M007    ... 324  2917 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 NIXEM  256 M17 26015 3  438 330  A593 036 0455 0008 0073 0332 05361 1315
        ... P19  M008    430 324  2701 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 SUBKU  256 M17 26017 3  438 330  A593 019 0436 0003 0070 0095 05265 1080
        ... P19  M008    430 324  2422 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 ATVAD  256 M17 25018 3  438 330  A593 007 0429 0001 0069 0035 05230 1080
        ... P19  M008    430 324  2422 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 LAGAL  256 M17 25020 2  438 330  A593 013 0416 0002 0067 0066 05165 1080
        ... P19  M009    429 324  2422 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 OMUDI  256 M16 25021 2  438 330  A593 037 0379 0005 0062 0186 04978 1080
        ... P19  M009    429 324  2530 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 DPX    256 M16 26024 2  438 330  A593 023 0356 0003 0059 0117 04862 1080
 112.4  ... P19  M012    426 324  2648 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
*UDINO  256 M16 27027 2  438 349  A593 034 0322 0005 0054 0171 04691 1080
        ... P19  M008    430 344  3872 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P58    256 M16 27030 2  438 349  A593 001 0321 0000 0054 0005 04686 1080
        ... P19  M012    426 343  4233 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P60    256 M16 27032 1  438 349  A593 014 0307 0002 0052 0071 04615 1080
        ... P19  M013    425 343  4233 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P86    256 M16 27032 1  438 349  A593 006 0301 0001 0051 0031 04584 1080
        ... P19  M013    425 343  4233 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 ABTUB  256 M16 27035 2  438 349  A593 052 0249 0007 0044 0264 04320 1080
        ... P19  M013    425 343  7166 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 DALIM  256 M16 27040 1  438 349  A593 026 0223 0004 0040 0132 04188 1080
        ... P19  M013    425 343  7166 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
*TUMLO  256 M16 26042 1  438 343  W157 052 0171 0007 0033 0265 03923 1080
        ... P19  M014    424 337  6969 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P148   157 M02 31006 2  373 349  W157 031 0140 0005 0028 0078 03845 0482
        ... P14  M005    368 343  2186 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 HG     157 M02 34007 2  373 276    H8 043 0097 0007 0021 0250 03594 1080
 350    ... P14  M002    371 271  2297 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P331   118 P05 03010 2  351 325   J42 015 0082 0003 0018 0052 03542 0607
        ... P13  M003    348 319  2133 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 P66    118 P05 03013 3  351 325   J42 022 0060 0004 0014 0136 03406 1080
        ... P13  M002    349 317  2133 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 FL     118 P05 04014 4  351 290   J42 015 0045 0003 0012 0091 03315 1080
 272    ... P13  P005    356 289  2133 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 SJW    118 P05 04014 4  351 288   J42 009 0036 0002 0010 0054 03261 1080
 117.7  ... P13  P007    358 282  2363 ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 TOD    118 P05 04014 4  ... ...    .. 007 0029 0001 0009 0047 03213 1080
        ... P13  M010    ... ...   ... ... .... .... .... .... ..... ....
-------------------------------------------------------------------------
 ZBSJ   ...  ..  .... .. ... ...    .. 029 .... 0009 .... 0144 03069 ....
 ELEV 00233FT           ... 092   ... ... .... .... .... .... ..... ....


CPT    LATI/LONGI      FL  WIND/T       FL  WIND/T       FL  WIND/T
----------------------------------------------------------------------
ZSNT   N32042E120588   ... .........    ... .........    ... ......... 
NTG    N32059E120588   118 18012/P09    79  19014/P16    59  19015/P19 
PIKAS  N32100E120430   118 18012/P09    79  19014/P16    59  19014/P19 
UNTAN  N32122E120171   217 25008/M09    177 21007/M01    157 20009/P02 
PIMOL  N32147E119457   217 25010/M09    177 23007/M01    157 21009/P02 
XUTGU  N32278E119345   276 28010/M21    236 26012/M13    217 25012/M09 
NIXEM  N32565E119096   276 28013/M20    236 25016/M12    217 25015/M09 
SUBKU  N33118E118564   276 28015/M20    236 25018/M12    217 24017/M09 
ATVAD  N33177E118513   276 28016/M20    236 24020/M12    217 24018/M08 
LAGAL  N33280E118423   276 27016/M20    236 24020/M12    217 24020/M08 
OMUDI  N33582E118160   276 27019/M20    236 24022/M12    217 24022/M08 
DPX    N34166E117600   276 27022/M20    236 25024/M12    217 25025/M08 
UDINO  N34493E117482   276 28026/M20    236 26028/M12    217 25028/M08 
P58    N34506E117477   276 28028/M20    236 26031/M12    217 26032/M09 
P60    N35042E117428   276 28029/M20    236 26031/M12    217 26032/M09 
P86    N35099E117407   276 27032/M20    236 27032/M12    217 26031/M09 
ABTUB  N36000E117221   276 27036/M20    236 27034/M12    217 26031/M08 
DALIM  N36251E117128   276 26041/M20    236 26036/M12    217 26031/M08 
TUMLO  N37130E116477   276 26042/M20    236 26037/M12    217 26031/M09 
P148   N37427E116363   177 29007/M04    138 34006/P01    118 00005/P05 
HG     N37431E115423   177 31007/M05    138 01009/P01    118 02008/P05 
P331   N37546E115297   138 01011/P01    98  06006/P09    79  10006/P13 
P66    N38100E115117   138 02014/P01    98  07009/P09    79  10008/P13 
FL     N38148E114534   138 02015/P01    98  08010/P10    79  10010/P14 
SJW    N38169E114410   138 02015/P01    98  09011/P10    79  10011/P14 
ZBSJ   N38168E114418   ... .........    ... .........    ... ......... 


                        MSA  TTK  DIST   FL   W/C   TIME  FUEL
ALTERNATE  - 1  ZSJN  .....  124  0223  167  P004  00/41  1449
CPT         LAT      LONG        MCS     DIST
ZBSJ       N38168   E114418      000     000
SJW        N38169   E114410      000     011
FL         N38148   E114534      108     009
P66        N38100   E115117      110     015
P331       N37546   E115297      145     022
HG         N37431   E115423      145     015
P148       N37427   E116363      096     043
P149       N37426   E116507      096     011
PANKI      N37177   E116600      169     026
YQG        N36499   E117129      165     030
ZSJN       N36514   E117129      000     041


                        MSA  TTK  DIST   FL   W/C   TIME  FUEL
ALTERNATE  - 2  ZBTJ  .....   66  0210  187  M001  00/39  1340
CPT         LAT      LONG        MCS     DIST
ZBSJ       N38168   E114418      000     000
OC         N38272   E114333      000     023
UBTAB      N38298   E114405      071     006
SAKOD      N38404   E115098      071     025
ENGIL      N38465   E115268      071     015
P390       N38570   E115550      071     024
JB         N39027   E116118      071     014
BOBAK      N39076   E116243      069     011
VYK        N39116   E116344      069     009
DOGAR      N39098   E116471      107     010
LADIX      N39078   E116595      107     010
CG         N39047   E117224      107     018
ZBTJ       N39075   E117208      000     045


------------------------------------------------------------------------
                                  RVSM
COAST IN COORD-................... RAMP COORD-..........................
ALTIMETER NO.1-................... ALTIMETER NO.1-......................
          NO.2-...................           NO.2-......................
          STBY-...................           STBY-......................
------------------------------------------------------------------------

DESTINATION ATIS:

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . .

RMK:


END OF CAFPS FLIGHTPLAN
";

        [TestMethod]
        public void TestScan()
        {
            var interpreter = new CfpInterpreter();
            var tokList = interpreter.Scan(cfp);
            foreach (var tok in tokList)
            {
                var s = tok.ToPrettyString(cfp);
                Console.WriteLine(s);
                if (tok.IsNewline())
                {
                    Console.WriteLine("====================================");
                }
            }
        }
        
        [TestMethod]
        public void TestParse()
        {
            var interpreter = new CfpInterpreter();
            interpreter.Parse(cfp);
        }
    }

    
    class CfpInterpreter
    {
        private NcParser _parser;
        private const string cfpGrammerPath = "Xal.Op.Foc3.Domain.Service.Mgmt.Disp.cfp.grammer";

        public CfpInterpreter()
        {
            _parser = NcParser.Load("::cfp", p =>
            {
                p.Scanner.Delims = new string[] { };
                p.Scanner.LineComment = new string[] { };
                p.Scanner.CommentStart = null;
                p.Scanner.CommentEnd = null;
                p.Scanner.Operators = new string[] { };
                p.Scanner.QuotationMarks = new string[] { };
                p.Scanner.RegexMarks = new string[] { };
                p.Scanner.LispChar = new string[] { };
                p.Scanner.SignificantWhitespaces = new string[] { "\n" };
            });
        }

        public IList<Token> Scan(string cfp)
        {
            return _parser.Scanner.Scan(cfp).ToList();
        }

        public ParseResult Parse(string cfp)
        {
            return _parser.ScanAndParse(cfp);
        }
    }
}
